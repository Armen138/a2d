var a2d={version:"0.4.0.1",a2dCanvas:null,a2dRoot:null,a2dOffset:null,forceClear:!1,resources:[],loaded:!1,offset:{X:0,Y:0},mute:!1,load:function(a){var b;for(b in a)a.hasOwnProperty(b)&&(a[b].match(/png$|jpg$|jpeg$|gif$|bmp$/i)?this.resources[b]=new Image:this.resources[b]=new a2d.Audio,this.resources[b].onload=this.progress,this.resources[b].onreadystatechange=function(){this.progress()},this.resources[b].src=a[b]);this.progress()},progress:function(){var a,b=0,c=0;if(!a2d.loaded){for(a in a2d.resources)a2d.resources.hasOwnProperty(a)&&((a2d.resources[a].width&&a2d.resources[a].width>0||a2d.resources[a].play)&&c++,b++);c==b?(a2d.loaded=!0,a2d.fireEvent("load")):a2d.fireEvent("progress",{loaded:c,total:b})}},get canvas(){if(!this.a2dCanvas){console.log("acquire canvas"),this.a2dCanvas=document.getElementsByTagName("canvas")[0];if(!this.a2dCanvas){this.a2dCanvas=document.createElement("canvas"),document.body.appendChild(this.a2dCanvas);var a=new a2d.Dimension(window.innerWidth,window.innerHeight);this.a2dCanvas.setAttribute("width",a.Width),this.a2dCanvas.setAttribute("height",a.Height)}a2d.mousePosition=new a2d.Position(0,0),this.a2dCanvas.addEventListener("mousemove",function(a){var b=a.clientX+a2d.canvas.offsetLeft,c=a.clientY+a2d.canvas.offsetTop;a2d.mousePosition=new a2d.Position(b,c),a2d.mousePosition.subtract(a2d.offset)}),this.a2dCanvas.addEventListener("mousedown",function(a){var b=a2d.root.findNodeAt(a2d.mousePosition);b&&b.fireEvent.call(b,"mousedown")}),this.a2dCanvas.addEventListener("mouseup",function(a){var b=a2d.root.findNodeAt(a2d.mousePosition);b&&(b.fireEvent.call(b,"mouseup"),b.fireEvent.call(b,"click"))}),this.context=this.a2dCanvas.getContext("2d")}return this.a2dCanvas},set canvas(a){this.a2dCanvas=document.getElementById(a)},get dimension(){return new a2d.Dimension(this.canvas.width,this.canvas.height)},set dimension(a){this.canvas.setAttribute("width",a.Width),this.canvas.setAttribute("height",a.Height)},get root(){return this.a2dRoot||(console.log("acquire root node"),this.a2dRoot=new a2d.Node,this.frame()),this.a2dRoot},set root(a){this.a2dRoot=a},frame:function(){a2d.forceClear&&(a2d.canvas.width=a2d.canvas.width),a2d.requestFrame(a2d.frame),a2d.root.draw(),a2d.fireEvent("draw")},requestFrame:function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1e3/60)}}().bind(window),key:{BACKSPACE:8,TAB:9,ENTER:13,SHIFT:16,CTRL:17,ALT:18,PAUSE:19,CAPS_LOCK:20,ESC:27,SPACE:32,PAGEUP:33,PAGEDOWN:34,END:35,HOME:36,ARROW_LEFT:37,ARROW_UP:38,ARROW_RIGHT:39,ARROW_DOWN:40,INSERT:45,DELETE:46,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,NUM_LOCK:144,SCROLL_LOCK:145}};a2d.Vector=function(a,b){"use strict",this.X=a,this.Y=b,this.clone=function(){return new a2d.Vector(this.X,this.Y)}},a2d.Position=function(a,b){"use strict",a2d.Vector.apply(this,[a,b]),this.scale=function(a){a.Width?(this.X=Math.floor(this.X*a.Width),this.Y=Math.floor(this.Y*a.Height)):(this.X=Math.floor(this.X*a.X),this.Y=Math.floor(this.Y*a.Y))},this.add=function(a){this.X+=a.X,this.Y+=a.Y},this.substract=function(a){this.subtract(a)},this.subtract=function(a){this.X-=a.X,this.Y-=a.Y},this.divide=function(a){this.X=Math.floor(this.X/a.X),this.Y=Math.floor(this.Y/a.Y)},this.isInside=function(a){return this.X>a.topLeft.X&&this.X<a.bottomRight.X&&this.Y>a.topLeft.Y&&this.Y<a.bottomRight.Y?!0:!1},this.is=function(a){return this.X===a.X&&this.Y===a.Y},this.not=function(a){return this.X!==a.X||this.Y!==a.Y},this.distanceTo=function(a){var b=Math.abs(this.X-a.X),c=Math.abs(this.Y-a.Y);return Math.sqrt(Math.pow(b,2)+Math.pow(c,2))},this.clone=function(){return new a2d.Position(this.X,this.Y)}},a2d.Rectangle=function(a,b){"use strict",this.topLeft=a,this.bottomRight=b,this.topRight=new a2d.Position(b.X,a.Y),this.bottomLeft=new a2d.Position(a.X,b.Y),this.add=function(a){this.topLeft.add(a),this.topRight.add(a),this.bottomLeft.add(a),this.bottomRight.add(a)},this.overlaps=function(a){return a.topLeft.isInside(this)||a.bottomRight.isInside(this)||a.topRight.isInside(this)||a.bottomLeft.isInside(this)}},a2d.Dimension=function(a,b){"use strict",this.Width=a,this.Height=b,this.scale=function(a){this.Width=Math.floor(this.Width*a.X),this.Height=Math.floor(this.Height*a.Y)}},a2d.Collection=function(){this.length=0,this.push=function(a){typeof a=="object"&&(a.parent=this),this[this.length]=a,this.length+=1},this.pop=function(){return this.length-=1,this[this.length]},this.remove=function(a){var b=this[a],c;delete this[a];for(c=a+1;c<this.length;c++)this[c-1]=this[c];return this.length-=1,b},this.shift=function(){return this.remove(0)},this.unshift=function(a){for(i=0;i<this.length;i++)this[i+1]=this[i];return this[0]=a,this.length+=1,this.length},this.indexOf=function(a){var b;for(b=0;b<this.length;b++)if(this[b]==a)return b;return-1},this.append=function(a){var b;for(b=0;b<a.length;b++)this.push(a[b])}},a2d.Events=function(){"use strict";var a=this,b={};this.hasEvent=function(a){return b[a]?!0:!1},this.addEventListener=function(a,c){b[a]||(b[a]=[]),b[a].push(c)},this.emit=function(a,b){this.fireEvent(a,b)},this.on=function(a,b){this.addEventListener(a,b)},this.fireEvent=function(c,d){var e,f="on"+c.charAt(0).toUpperCase()+c.slice(1);if(b[c])for(e=0;e<b[c].length;e++)b[c][e](d);a[f]&&a[f](d)},this.removeEventListener=function(a,c){var d=-1;b[a]&&(d=b[a].indexOf(c),d!=-1&&b[a].splice(d,1))}},a2d.Events.apply(a2d),a2d.Audio=function(){this.channels=[],this.channels.length=8,this.play=function(){if(!a2d.mute){var a=!1;for(var b=0;b<this.channels.length;b++)if(this.channels[b].currentTime==0||this.channels[b].ended){this.channels[b].play(),a=!0;break}a||(this.channels[0].pause(),this.channels[0].currentTime=0,this.channels[0].play())}},this.__defineSetter__("src",function(a){for(var b=0;b<this.channels.length;b++)this.channels[b]=new Audio,this.channels[b].src=a})},a2d.Node=function(){"use strict",a2d.Collection.apply(this),a2d.Events.apply(this);var a=this;this.scrollLock=!1,this.opacity=1,this.boundingBox=new a2d.Rectangle(new a2d.Position(0,0),new a2d.Position(0,0)),this.hover=!1,this.scale=new a2d.Vector(1,1),this.visible=!0,this.name="Node",this.findNodeAt=function(b){var c=new a2d.Position(b.X,b.Y);this.scrollLock&&c.add(a2d.offset);for(var d=a.length-1;d>=0;d--){var e=a[d].findNodeAt(c);if(e)return e}return c.isInside(a.boundingBox)&&(a.hasEvent("click")||a.hasEvent("mousedown"))?a:null},this.draw=function(){var a,b=a2d.mousePosition?new a2d.Position(a2d.mousePosition.X,a2d.mousePosition.Y):new a2d.Position(0,0);this.scrollLock&&b.add(a2d.offset),b&&b.isInside(this.boundingBox)?this.hover||(this.fireEvent("mouseover"),this.hover=!0):this.hover&&(this.fireEvent("mouseout"),this.hover=!1);if(this.visible)for(a=0;a<this.length;a++)this[a].draw()}},a2d.Tile=function(a){"use strict",a2d.Node.apply(this);var b=0,c=new a2d.Position(0,0),d=!1,e=this,f=!1,g=null,h=this.draw.bind(this),i=function(){a.width<a.height?e.tileSize=new a2d.Dimension(a.width,a.width):e.tileSize=new a2d.Dimension(a.height,a.height)},j=function(){var a=e.position.X,b=e.position.Y;a<0&&(a+=a2d.dimension.Width),b<0&&(b+=a2d.dimension.Height),e.boundingBox.topLeft.X=a-e.tileSize.Width/2,e.boundingBox.topLeft.Y=b-e.tileSize.Height/2,e.boundingBox.bottomRight.X=a+e.tileSize.Width/2,e.boundingBox.bottomRight.Y=b+e.tileSize.Height/2,e.boundingBox.topRight.X=a+e.tileSize.Width/2,e.boundingBox.topRight.Y=b-e.tileSize.Height/2,e.boundingBox.bottomLeft.X=a-e.tileSize.Width/2,e.boundingBox.bottomLeft.Y=b+e.tileSize.Height/2};this.image=a,this.tile=0,this.loop=!1,this.range=new a2d.Vector(0,0),this.fps=8,this.angle=0,this.tileSize=new a2d.Dimension(0,0),this.position=new a2d.Position(0,0),this.opacity=1,this.scrollLock=!1,this.setTile=function(a){this.tile=a,a!==-1&&(c.Y=parseInt(a/(this.image.width/this.tileSize.Height),10)*this.tileSize.Height,c.X=parseInt(a%(this.image.width/this.tileSize.Height),10)*this.tileSize.Width)},this.frameLoop=function(a,c){this.range=a,this.loop=c,d=!0,b=(new Date).getTime()},this.draw=function(a,f){var g=a||a2d.canvas,i=g.getContext("2d");j();if(b!==0){var k=(new Date).getTime()-b,l=this.range.Y-this.range.X,m=l/this.fps*1e3;if(k>m)this.loop?(b=(new Date).getTime(),d=!d):(b=0,this.fireEvent("animationend"));else{var n=1e3/this.fps;d?this.setTile(Math.floor(k/n)+this.range.X):this.setTile(this.range.Y-Math.floor(k/n))}}if(this.visible){var o=new a2d.Position(this.position.X,this.position.Y);e.scrollLock&&o.X<0&&(o.X+=a2d.dimension.Width),e.scrollLock&&o.Y<0&&(o.Y+=a2d.dimension.Height),this.relative&&o.add(this.parent.position),this.scrollLock||o.add(a2d.offset),f&&o.scale(f),i.save(),i.translate(o.X,o.Y),i.rotate(this.angle),f?i.scale(f.X,f.Y):i.scale(this.scale.X,this.scale.Y),i.globalAlpha=this.opacity,i.drawImage(this.image,c.X,c.Y,this.tileSize.Width,this.tileSize.Height,-(this.tileSize.Width/2),-(this.tileSize.Height/2),this.tileSize.Width,this.tileSize.Height),i.restore()}h()},i(),this.setTile(this.tile)},a2d.TileGrid=function(a){"use strict",a2d.Node.apply(this);var b=this,c=this.draw.bind(this),d=this.fireEvent.bind(this),e=[],f=new a2d.Dimension(0,0),g=new a2d.Dimension(0,0),h=null,i=document.createElement("canvas");i.width=a2d.dimension.Width,i.height=a2d.dimension.Height,this.boundingBox=new a2d.Rectangle(new a2d.Position(0,0),new a2d.Position(a2d.dimension.Width,a2d.dimension.Height)),this.scrollLock=!0,this.setData=function(a){var b,c,d=0;g=new a2d.Dimension(a.gridSize[0],a.gridSize[1]),f=new a2d.Dimension(a.tileSize[0],a.tileSize[1]);for(b=0;b<g.Width;b++){e[b]||(e[b]=[]);for(c=0;c<g.Height;c++)e[b][c]=new a2d.Tile(a2d.resources[a.tileSet]),e[b][c].tileSize=f,e[b][c].setTile(a.tiles[d]),a.tiles[d]!==-1&&(e[b][c].edit=!0),e[b][c].position=new a2d.Position(b*f.Width+f.Width/2,c*f.Height+f.Height/2),d++}},this.fireEvent=function(a,c){a==="click"&&(c||(c={}),c.tile=b.getTile(a2d.mousePosition),c.tileType=e[c.tile.X][c.tile.Y].tile),d(a,c)},this.getWidth=function(){return g.Width},this.getHeight=function(){return g.Height},this.getTile=function(a){return new a2d.Position(Math.floor(a.X/f.Width),Math.floor(a.Y/f.Height))},this.toPix=function(a){return new a2d.Position(a.X*f.Width+parseInt(f.Width/2,10),a.Y*f.Height+parseInt(f.Height/2,10))},this.getTiles=function(){return e},this.draw=function(){var a,b,d,j;if(this.visible){if(!h||h.not(a2d.offset)){d=this.getTile(a2d.offset),d.add(new a2d.Position(1,1)),d.scale(new a2d.Position(-1,-1)),j=new a2d.Position(d.X+Math.floor(a2d.dimension.Width/f.Width)+1+1,d.Y+Math.floor(a2d.dimension.Height/f.Height)+1+1),j.X>g.Width&&(j.X=g.Width),j.Y>g.Height&&(j.Y=g.Height),d.X<0&&(d.X=0),d.Y<0&&(d.Y=0);for(a=d.X;a<j.X;a++)for(b=d.Y;b<j.Y;b++)e[a][b].tile!==-1&&e[a][b].draw(i);h=new a2d.Position(a2d.offset.X,a2d.offset.Y)}a2d.context.drawImage(i,0,0)}c()},this.visibleArea=function(){return{from:this.getTile(a2d.offset),to:new a2d.Position(fromTile.X+Math.floor(a2d.dimension.Width/f.Width)+1+1,fromTile.Y+Math.floor(a2d.dimension.Height/f.Height)+1+1)}},this.getMini=function(a){var b=document.createElement("canvas"),c=b.getContext("2d"),d=f.Width*g.Width,h=f.Height*g.Height,i=new a2d.Vector(a.Width/d,a.Height/h);b.width=a.Width,b.height=a.Height;for(var j=0;j<g.Width;j++)for(var k=0;k<g.Height;k++)e[j][k].draw(b,i);return new a2d.Tile(b)},a&&this.setData(a)},a2d.Particles=function(a){a2d.Node.apply(this);var b=this,c=a.lifeTime||1e3,d=a.speed||200,e=a.frequency||300,f=a.rotateSpeed||.01,g=a.startScale||1,h=a.endScale||0,i=a.image,j=0,k=0,l=this.draw.bind(this);b.position=a.position||new a2d.Position(0,0),this.draw=function(){var a=(new Date).getTime();j===0&&(j=a),k===0&&(k=a);var m=a-j,n=Math.floor(m/(1e3/e));!(n>0);for(var o=0;o<n;o++){var p=new a2d.Tile(i),q=Math.random()*6.28;p.birth=(new Date).getTime(),p.position=new a2d.Position(b.position.X,b.position.Y),b.relative&&p.position.add(this.parent.position),p.dir=new a2d.Vector(Math.cos(q),Math.sin(q)),j=p.birth,b.push(p)}for(var o=b.length-1;o>=0;--o){var r=a-b[o].birth,s=g-h;b[o].opacity=1-r/c,b[o].angle=r/c*360*f,b[o].scale.X=g-r/c*s,b[o].scale.Y=g-r/c*s,b[o].position.X+=b[o].dir.X*d*((a-k)/1e3),b[o].position.Y+=b[o].dir.Y*d*((a-k)/1e3),r>c&&b.remove(o)}k=a,l()}},a2d.Label=function(a){"use strict",a2d.Node.apply(this);var b=this,c=a,d=this.draw.bind(this);this.font="21px Arial",this.draw=function(){var a=b.position.clone();b.scrollLock||a.add(a2d.offset),a2d.context.font=b.font,a2d.context.fillText(c,a.X,a.Y),d()}};